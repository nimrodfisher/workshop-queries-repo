version: 2

models:
  - name: accounts
    description: |
      Core accounts/organizations table. Represents the top-level organization entity in the system.
      All other entities (users, subscriptions, events) are associated with an account.
    synonyms:
      - organizations
      - companies
      - clients
      - customers
      - tenants
    columns:
      - name: id
        description: Unique identifier for the account (UUID)
        data_type: uuid
        synonyms:
          - account_id
          - org_id
          - organization_id
          - company_id
        constraints:
          - type: primary_key
          - type: not_null
      - name: name
        description: Account/organization name
        data_type: text
        synonyms:
          - account_name
          - org_name
          - company_name
          - customer_name
      - name: industry
        description: Industry classification for the account (e.g., SaaS, Finance, Healthcare)
        data_type: text
        synonyms:
          - vertical
          - sector
          - business_type
      - name: plan
        description: Subscription plan tier (e.g., Free, Pro, Enterprise)
        data_type: text
        synonyms:
          - tier
          - subscription_plan
          - pricing_tier
          - subscription_tier
      - name: created_at
        description: Timestamp when the account was created
        data_type: timestamp with time zone
        synonyms:
          - signup_date
          - onboarded_at
          - established_at
        default: now()

  - name: users
    description: |
      Users belonging to accounts. Each user is associated with exactly one account (org_id).
      Tracks user profile information and role within the organization.
    synonyms:
      - team_members
      - people
      - employees
      - members
      - account_users
    columns:
      - name: id
        description: Unique identifier for the user (UUID)
        data_type: uuid
        synonyms:
          - user_id
          - member_id
        constraints:
          - type: primary_key
          - type: not_null
      - name: org_id
        description: Foreign key reference to the parent account
        data_type: uuid
        synonyms:
          - account_id
          - organization_id
          - company_id
        constraints:
          - type: foreign_key
            reference_table: accounts
            reference_column: id
            on_delete: CASCADE
      - name: full_name
        description: User's full name
        data_type: text
        synonyms:
          - name
          - user_name
          - member_name
      - name: email
        description: User's email address
        data_type: text
        synonyms:
          - email_address
          - user_email
      - name: role
        description: User's role within the organization (e.g., admin, member, viewer)
        data_type: text
        synonyms:
          - user_role
          - permission_level
          - access_level
      - name: created_at
        description: Timestamp when the user was created
        data_type: timestamp with time zone
        synonyms:
          - signup_date
          - joined_at
          - registration_date
        default: now()

  - name: events
    description: |
      Event tracking table. Records user activities and system events.
      Each event is associated with an organization and optionally a specific user.
      The props column stores flexible JSON data specific to each event type.
    synonyms:
      - activities
      - actions
      - logs
      - tracking_events
      - event_logs
      - user_activities
    columns:
      - name: id
        description: Unique identifier for the event (auto-incrementing bigint)
        data_type: bigint
        synonyms:
          - event_id
        constraints:
          - type: primary_key
          - type: not_null
      - name: org_id
        description: Foreign key reference to the account/organization
        data_type: uuid
        synonyms:
          - account_id
          - organization_id
          - company_id
        constraints:
          - type: foreign_key
            reference_table: accounts
            reference_column: id
            on_delete: CASCADE
      - name: user_id
        description: Foreign key reference to the user who triggered the event (nullable)
        data_type: uuid
        synonyms:
          - actor_id
          - person_id
          - member_id
        constraints:
          - type: foreign_key
            reference_table: users
            reference_column: id
            on_delete: CASCADE
      - name: event_type
        description: Type/category of the event (e.g., login, signup, action_completed)
        data_type: text
        synonyms:
          - type
          - action
          - activity_type
          - event_name
      - name: props
        description: JSON object containing event-specific properties and metadata
        data_type: jsonb
        synonyms:
          - properties
          - metadata
          - event_data
          - payload
      - name: occurred_at
        description: Timestamp when the event occurred
        data_type: timestamp with time zone
        synonyms:
          - timestamp
          - event_time
          - created_at
          - date

  - name: products
    description: |
      Product catalog. Defines the products available for subscription.
      Products have monthly pricing and can be activated/deactivated.
    synonyms:
      - offerings
      - services
      - plans
      - tiers
      - items
    columns:
      - name: id
        description: Unique identifier for the product (UUID)
        data_type: uuid
        synonyms:
          - product_id
          - offering_id
          - item_id
        constraints:
          - type: primary_key
          - type: not_null
      - name: name
        description: Product name
        data_type: text
        synonyms:
          - product_name
          - offering_name
          - title
      - name: price_monthly
        description: Monthly subscription price in the organization's currency
        data_type: numeric
        synonyms:
          - monthly_price
          - monthly_cost
          - monthly_fee
          - price
      - name: active
        description: Whether the product is currently available for new subscriptions
        data_type: boolean
        synonyms:
          - is_active
          - enabled
          - status
        default: true

  - name: subscriptions
    description: |
      Subscriptions table. Tracks which accounts are subscribed to which products.
      Manages subscription lifecycle including start and cancellation dates.
      Note: Product foreign key constraint is missing in the schema but should reference products(id).
    synonyms:
      - plans
      - memberships
      - purchases
      - contracts
      - agreements
    columns:
      - name: id
        description: Unique identifier for the subscription (UUID)
        data_type: uuid
        synonyms:
          - subscription_id
          - membership_id
          - plan_id
        constraints:
          - type: primary_key
          - type: not_null
      - name: org_id
        description: Foreign key reference to the account/organization
        data_type: uuid
        synonyms:
          - account_id
          - organization_id
          - company_id
          - customer_id
        constraints:
          - type: foreign_key
            reference_table: accounts
            reference_column: id
            on_delete: CASCADE
      - name: product_id
        description: Foreign key reference to the product (implied relationship to products table)
        data_type: uuid
        synonyms:
          - offering_id
          - plan_product_id
      - name: status
        description: Current subscription status (e.g., active, paused, canceled, trial)
        data_type: text
        synonyms:
          - subscription_status
          - state
          - lifecycle_status
      - name: started_at
        description: Date when the subscription started
        data_type: date
        synonyms:
          - start_date
          - activation_date
          - effective_date
      - name: canceled_at
        description: Date when the subscription was canceled (null if still active)
        data_type: date
        synonyms:
          - cancellation_date
          - end_date
          - termination_date
      - name: monthly_price
        description: Agreed-upon monthly price for this subscription at the time of creation
        data_type: numeric
        synonyms:
          - price_monthly
          - monthly_cost
          - contract_price
          - monthly_fee

  - name: invoices
    description: |
      Invoices table. Records billing invoices generated for subscriptions.
      Tracks invoice amounts, issuance dates, and payment dates.
    synonyms:
      - bills
      - receipts
      - billing_records
      - transactions
    columns:
      - name: id
        description: Unique identifier for the invoice (UUID)
        data_type: uuid
        synonyms:
          - invoice_id
          - bill_id
          - transaction_id
        constraints:
          - type: primary_key
          - type: not_null
      - name: subscription_id
        description: Foreign key reference to the subscription
        data_type: uuid
        synonyms:
          - plan_id
          - membership_id
        constraints:
          - type: foreign_key
            reference_table: subscriptions
            reference_column: id
      - name: amount
        description: Invoice amount in the organization's currency
        data_type: numeric
        synonyms:
          - invoice_amount
          - total
          - price
          - cost
      - name: issued_at
        description: Date when the invoice was issued
        data_type: date
        synonyms:
          - issue_date
          - creation_date
          - generated_at
      - name: paid_at
        description: Date when the invoice was paid (null if unpaid)
        data_type: date
        synonyms:
          - payment_date
          - paid_date
          - settlement_date

  - name: marketing_touchpoints
    description: |
      Marketing touchpoints table. Records customer interactions with marketing campaigns and channels.
      Tracks when and how customers were reached through various marketing channels.
      Enables campaign performance analysis and customer journey tracking.
    synonyms:
      - marketing_interactions
      - campaign_touchpoints
      - customer_interactions
      - marketing_events
      - campaign_engagements
    columns:
      - name: id
        description: Unique identifier for the marketing touchpoint (UUID)
        data_type: uuid
        synonyms:
          - touchpoint_id
          - interaction_id
          - event_id
        constraints:
          - type: primary_key
          - type: not_null
      - name: org_id
        description: Foreign key reference to the account/organization that was touched
        data_type: uuid
        synonyms:
          - account_id
          - organization_id
          - company_id
          - customer_id
        constraints:
          - type: foreign_key
            reference_table: accounts
            reference_column: id
            on_delete: CASCADE
      - name: campaign
        description: Name or identifier of the marketing campaign (e.g., Q4_Launch, Summer_Promo)
        data_type: text
        synonyms:
          - campaign_name
          - campaign_id
          - promotion_name
          - marketing_campaign
      - name: channel
        description: |
          Marketing channel through which the touchpoint occurred 
          (e.g., email, social, paid_ads, organic_search, direct_mail, webinar)
        data_type: text
        synonyms:
          - marketing_channel
          - channel_name
          - touchpoint_channel
          - medium
      - name: touched_at
        description: Timestamp when the marketing touchpoint occurred
        data_type: timestamp with time zone
        synonyms:
          - interaction_date
          - engagement_date
          - timestamp
          - created_at
          - occurred_at

  - name: support_tickets
    description: |
      Support tickets table. Records customer support requests and issues.
      Tracks ticket lifecycle from creation to resolution, including ticket category, status, and resolution time.
      Enables customer support metrics tracking, SLA monitoring, and support team performance analysis.
    synonyms:
      - tickets
      - support_cases
      - help_requests
      - customer_issues
      - support_requests
      - support_cases
    columns:
      - name: id
        description: Unique identifier for the support ticket (UUID)
        data_type: uuid
        synonyms:
          - ticket_id
          - case_id
          - issue_id
          - support_id
        constraints:
          - type: primary_key
          - type: not_null
      - name: org_id
        description: Foreign key reference to the account/organization that created the ticket
        data_type: uuid
        synonyms:
          - account_id
          - organization_id
          - company_id
          - customer_id
        constraints:
          - type: foreign_key
            reference_table: accounts
            reference_column: id
            on_delete: CASCADE
      - name: opened_by
        description: Foreign key reference to the user who opened the ticket (nullable - may be system-generated)
        data_type: uuid
        synonyms:
          - created_by
          - requester_id
          - user_id
          - reporter_id
      - name: status
        description: |
          Current status of the support ticket 
          (e.g., open, in_progress, waiting_on_customer, resolved, closed, reopened)
        data_type: text
        synonyms:
          - ticket_status
          - state
          - ticket_state
          - resolution_status
      - name: category
        description: |
          Category or type of support ticket 
          (e.g., billing, technical, feature_request, bug_report, general_inquiry, onboarding)
        data_type: text
        synonyms:
          - ticket_category
          - issue_type
          - ticket_type
          - issue_category
          - support_type
      - name: opened_at
        description: Timestamp when the support ticket was opened
        data_type: timestamp with time zone
        synonyms:
          - created_at
          - ticket_creation_date
          - opened_date
          - created_date
      - name: closed_at
        description: Timestamp when the support ticket was closed (null if still open or unresolved)
        data_type: timestamp with time zone
        synonyms:
          - resolved_at
          - closed_date
          - resolution_date
          - completed_at
          - settled_at

relationships:
  - from_model: users
    from_column: org_id
    to_model: accounts
    to_column: id
    description: Each user belongs to exactly one account

  - from_model: events
    from_column: org_id
    to_model: accounts
    to_column: id
    description: Each event is associated with an account

  - from_model: events
    from_column: user_id
    to_model: users
    to_column: id
    description: Each event can be attributed to a user (optional)

  - from_model: subscriptions
    from_column: org_id
    to_model: accounts
    to_column: id
    description: Each subscription belongs to an account

  - from_model: subscriptions
    from_column: product_id
    to_model: products
    to_column: id
    description: Each subscription is for a specific product

  - from_model: invoices
    from_column: subscription_id
    to_model: subscriptions
    to_column: id
    description: Each invoice is associated with a subscription

  - from_model: marketing_touchpoints
    from_column: org_id
    to_model: accounts
    to_column: id
    description: Each marketing touchpoint is associated with an account

  - from_model: support_tickets
    from_column: org_id
    to_model: accounts
    to_column: id
    description: Each support ticket belongs to an account

  - from_model: support_tickets
    from_column: opened_by
    to_model: users
    to_column: id
    description: Each support ticket is opened by a user (optional, may be system-generated)

notes: |
  Schema Overview:
  - Accounts are the top-level organizational unit
  - Users and Events are associated with Accounts
  - Subscriptions link Accounts to Products
  - Invoices are generated from Subscriptions
  - Marketing Touchpoints track customer interactions with accounts
  - Support Tickets track customer support requests and issues
  - Deletion is cascading from Accounts to Users, Events, Subscriptions, Marketing Touchpoints, and Support Tickets

  Data Quality Notes:
  - Most columns are nullable; consider adding NOT NULL constraints where appropriate
  - Subscription.product_id lacks an explicit foreign key constraint
  - Consider adding unique constraints on emails or account names if needed
  - Event timestamps (occurred_at) may have timezone implications depending on storage requirements
  - Marketing_touchpoints.touched_at should use consistent timezone (UTC recommended)
  - Support_tickets.opened_by may be NULL for system-generated tickets
  - Support_tickets.closed_at will be NULL for open/unresolved tickets
  - Campaign and channel names should be standardized for accurate reporting
  - Support ticket status and category values should be standardized

common_business_questions:
  - question: "How many customers/organizations do we have?"
    synonyms:
      - "total accounts"
      - "number of companies"
      - "organization count"
    query_pattern: "SELECT COUNT(*) FROM accounts;"
  
  - question: "Which accounts are on which plan?"
    synonyms:
      - "plan distribution"
      - "customer plans"
      - "tier breakdown"
    query_pattern: |
      SELECT 
        plan, 
        COUNT(*) as account_count
      FROM accounts
      GROUP BY plan
      ORDER BY account_count DESC;
  
  - question: "How many users belong to each account?"
    synonyms:
      - "team size per organization"
      - "members per company"
      - "user distribution"
    query_pattern: |
      SELECT 
        org_id, 
        COUNT(*) as user_count
      FROM users
      GROUP BY org_id
      ORDER BY user_count DESC;
  
  - question: "Which accounts have canceled subscriptions?"
    synonyms:
      - "churned customers"
      - "unsubscribed accounts"
      - "inactive subscriptions"
    query_pattern: |
      SELECT DISTINCT 
        org_id
      FROM subscriptions
      WHERE status = 'canceled';
  
  - question: "How much revenue do we have?"
    synonyms:
      - "total MRR"
      - "monthly recurring revenue"
      - "subscription revenue"
      - "total billing"
    query_pattern: |
      SELECT 
        SUM(monthly_price) as total_mrr,
        SUM(monthly_price * 12) as total_arr,
        COUNT(*) as subscription_count
      FROM subscriptions
      WHERE status = 'active';
  
  - question: "What are the most common events?"
    synonyms:
      - "top activities"
      - "popular actions"
      - "frequent event types"
    query_pattern: |
      SELECT 
        event_type, 
        COUNT(*) as event_count
      FROM events
      GROUP BY event_type
      ORDER BY event_count DESC;
  
  - question: "Which accounts have the most events?"
    synonyms:
      - "most active customers"
      - "engaged organizations"
      - "high-activity accounts"
    query_pattern: |
      SELECT 
        org_id, 
        COUNT(*) as total_events
      FROM events
      GROUP BY org_id
      ORDER BY total_events DESC;
  
  - question: "What is our unpaid invoice status?"
    synonyms:
      - "outstanding payments"
      - "unpaid bills"
      - "overdue invoices"
    query_pattern: |
      SELECT 
        COUNT(*) as unpaid_count,
        SUM(amount) as total_unpaid_amount
      FROM invoices
      WHERE paid_at IS NULL;
  
  - question: "How many users registered last month?"
    synonyms:
      - "new user signups"
      - "recent member additions"
      - "account creations"
    query_pattern: |
      SELECT 
        COUNT(*) as new_users
      FROM users
      WHERE created_at >= DATE_TRUNC('month', NOW()) - INTERVAL '1 month';
  
  - question: "Which product is most popular?"
    synonyms:
      - "best-selling product"
      - "most subscribed offering"
      - "top tier"
    query_pattern: |
      SELECT 
        product_id, 
        COUNT(*) as subscription_count
      FROM subscriptions
      GROUP BY product_id
      ORDER BY subscription_count DESC;

  - question: "Which marketing channels drive the most touchpoints?"
    synonyms:
      - "top marketing channels"
      - "most active channels"
      - "best performing channels"
    query_pattern: |
      SELECT 
        channel,
        COUNT(*) as touchpoint_count,
        COUNT(DISTINCT org_id) as unique_accounts
      FROM marketing_touchpoints
      GROUP BY channel
      ORDER BY touchpoint_count DESC;

  - question: "How many accounts were touched by each campaign?"
    synonyms:
      - "campaign reach"
      - "accounts per campaign"
      - "campaign performance"
      - "campaign engagement count"
    query_pattern: |
      SELECT 
        campaign,
        COUNT(DISTINCT org_id) as accounts_touched,
        COUNT(*) as total_touchpoints
      FROM marketing_touchpoints
      GROUP BY campaign
      ORDER BY accounts_touched DESC;

  - question: "What's the most recent marketing touchpoint for each account?"
    synonyms:
      - "last marketing interaction"
      - "most recent campaign"
      - "latest touchpoint per account"
    query_pattern: |
      SELECT 
        a.name as account_name,
        mt.campaign,
        mt.channel,
        mt.touched_at,
        DATEDIFF(day, mt.touched_at, NOW()) as days_since_touchpoint
      FROM marketing_touchpoints mt
      JOIN accounts a ON mt.org_id = a.id
      WHERE mt.touched_at = (
        SELECT MAX(touched_at) 
        FROM marketing_touchpoints 
        WHERE org_id = mt.org_id
      )
      ORDER BY mt.touched_at DESC;

  - question: "How many open support tickets do we have?"
    synonyms:
      - "open tickets"
      - "pending support cases"
      - "unresolved tickets"
      - "active support tickets"
    query_pattern: |
      SELECT 
        COUNT(*) as open_tickets,
        COUNT(DISTINCT org_id) as accounts_with_open_tickets
      FROM support_tickets
      WHERE status != 'closed'
        AND closed_at IS NULL;

  - question: "What are the most common support ticket categories?"
    synonyms:
      - "top ticket types"
      - "support issue categories"
      - "most common issues"
      - "ticket type breakdown"
    query_pattern: |
      SELECT 
        category,
        COUNT(*) as ticket_count,
        ROUND(100.0 * COUNT(*) / (SELECT COUNT(*) FROM support_tickets), 2) as pct_of_total
      FROM support_tickets
      GROUP BY category
      ORDER BY ticket_count DESC;

  - question: "What's the average time to resolve support tickets?"
    synonyms:
      - "average resolution time"
      - "mean time to resolution"
      - "MTTR"
      - "ticket resolution time"
      - "average ticket duration"
    query_pattern: |
      SELECT 
        category,
        COUNT(*) as resolved_tickets,
        ROUND(AVG(DATE_PART('day', closed_at - opened_at)), 2) as avg_days_to_resolve,
        MIN(DATE_PART('day', closed_at - opened_at)) as min_days,
        MAX(DATE_PART('day', closed_at - opened_at)) as max_days
      FROM support_tickets
      WHERE closed_at IS NOT NULL
      GROUP BY category
      ORDER BY avg_days_to_resolve DESC;

  - question: "Which accounts have the most open support tickets?"
    synonyms:
      - "accounts with most issues"
      - "high support volume customers"
      - "accounts needing attention"
      - "problematic customers"
    query_pattern: |
      SELECT 
        a.name as account_name,
        a.plan,
        COUNT(*) as total_tickets,
        COUNT(CASE WHEN st.status != 'closed' AND st.closed_at IS NULL THEN 1 END) as open_tickets,
        MAX(st.opened_at) as most_recent_ticket
      FROM support_tickets st
      JOIN accounts a ON st.org_id = a.id
      GROUP BY a.id, a.name, a.plan
      HAVING COUNT(*) > 0
      ORDER BY open_tickets DESC;

  - question: "How many support tickets were opened this month?"
    synonyms:
      - "new tickets this month"
      - "monthly ticket volume"
      - "ticket creation rate"
      - "tickets opened recently"
    query_pattern: |
      SELECT 
        DATE_TRUNC('week', opened_at)::date as week,
        COUNT(*) as tickets_opened,
        COUNT(DISTINCT org_id) as accounts_with_tickets
      FROM support_tickets
      WHERE opened_at >= DATE_TRUNC('month', NOW())
      GROUP BY DATE_TRUNC('week', opened_at)
      ORDER BY week DESC;

common_metrics:
  - name: "ARR (Annual Recurring Revenue)"
    synonyms: ["annual recurring revenue", "yearly revenue"]
    calculation: "SUM(monthly_price * 12) WHERE status = 'active'"
  
  - name: "MRR (Monthly Recurring Revenue)"
    synonyms: ["monthly recurring revenue", "monthly revenue", "total billing"]
    calculation: "SUM(monthly_price) WHERE status = 'active'"
  
  - name: "Churn Rate"
    synonyms: ["subscription churn", "cancellation rate", "attrition"]
    calculation: "COUNT(canceled_at) / COUNT(*) WHERE status = 'canceled' or 'active'"
  
  - name: "Net Revenue Retention"
    synonyms: ["NRR", "revenue retention"]
    calculation: "SUM(monthly_price current period) / SUM(monthly_price previous period)"
  
  - name: "Customer Acquisition Cost"
    synonyms: ["CAC", "acquisition cost"]
    calculation: "Total Marketing Spend / New Customers Acquired"
  
  - name: "User Engagement"
    synonyms: ["activity level", "user activity", "engagement score"]
    calculation: "COUNT(events) per user / time period"
  
  - name: "Invoice Collection Rate"
    synonyms: ["payment rate", "invoice payment", "collection efficiency"]
    calculation: "COUNT(paid_at IS NOT NULL) / COUNT(*) FROM invoices"

  - name: "Marketing Reach"
    synonyms: ["marketing touchpoint coverage", "accounts reached", "audience reach"]
    calculation: "COUNT(DISTINCT org_id) FROM marketing_touchpoints"

  - name: "Campaign Performance"
    synonyms: ["campaign engagement", "campaign touchpoints", "marketing performance"]
    calculation: "COUNT(*) FROM marketing_touchpoints WHERE campaign = 'X' GROUP BY campaign"

  - name: "Support Ticket Volume"
    synonyms: ["ticket count", "number of tickets", "support requests"]
    calculation: "COUNT(*) FROM support_tickets"

  - name: "Mean Time To Resolution (MTTR)"
    synonyms: ["average resolution time", "resolution speed", "ticket resolution time"]
    calculation: "AVG(DATE_PART('day', closed_at - opened_at)) FROM support_tickets WHERE closed_at IS NOT NULL"

  - name: "Support Ticket Resolution Rate"
    synonyms: ["ticket closure rate", "resolution percentage", "tickets resolved"]
    calculation: "COUNT(closed_at IS NOT NULL) / COUNT(*) FROM support_tickets"

  - name: "Open Support Tickets"
    synonyms: ["pending tickets", "unresolved tickets", "active support cases"]
    calculation: "COUNT(*) FROM support_tickets WHERE closed_at IS NULL"

sql_style_guide: |
  ## SQL Formatting Guidelines
  
  Always follow these formatting rules when generating SQL:
  
  ### Keywords (UPPERCASE)
  - SELECT, FROM, WHERE, AND, OR, NOT
  - JOIN, INNER JOIN, LEFT JOIN, RIGHT JOIN, FULL OUTER JOIN
  - GROUP BY, ORDER BY, HAVING
  - WITH, AS (for CTEs)
  - CASE, WHEN, THEN, ELSE, END
  - INSERT, UPDATE, DELETE, CREATE, DROP
  - SUM, COUNT, AVG, MAX, MIN, DISTINCT
  - LIMIT, OFFSET
  - IS NULL, IS NOT NULL
  
  ### Identifiers (lowercase)
  - Table names: accounts, users, subscriptions, invoices, events, products
  - Column names: id, org_id, user_id, created_at, monthly_price, etc.
  - Aliases: AS alias_name (keyword uppercase, name lowercase)
  
  ### Example Format:
  ```sql
  SELECT 
    a.name,
    COUNT(s.id) as subscription_count,
    SUM(s.monthly_price) as total_mrr
  FROM subscriptions s
  JOIN accounts a ON s.org_id = a.id
  WHERE s.status = 'active'
  GROUP BY a.id, a.name
  ORDER BY total_mrr DESC;
  ```
  
  ### Complex Query Example with WITH:
  ```sql
  WITH monthly_revenue AS (
    SELECT 
      org_id,
      DATE_TRUNC('month', created_at)::date as month,
      SUM(monthly_price) as mrr
    FROM subscriptions
    WHERE status = 'active'
    GROUP BY org_id, DATE_TRUNC('month', created_at)
  )
  SELECT 
    org_id,
    month,
    mrr,
    LAG(mrr) OVER (PARTITION BY org_id ORDER BY month) as previous_month_mrr
  FROM monthly_revenue
  ORDER BY org_id, month DESC;
  ```
  
  ### Rules Summary:
  ✓ UPPERCASE: All SQL keywords
  ✓ lowercase: All table and column names
  ✓ snake_case: For column names (user_id, created_at, monthly_price)
  ✓ Indentation: 2 or 4 spaces for readability
  ✓ Aliases: Use meaningful names (accounts AS a, subscriptions AS s)
  ✓ Formatting: Multi-line queries for readability
